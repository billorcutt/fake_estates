<html>
<head>
    <script src="https://rawgit.com/billorcutt/i_dropped_my_phone_the_screen_cracked/master/dist/cracked.js"></script>
    <script src="./synth.cracked.js"></script>
</head>
<body>

<script>

    (function() {

        var pad_array = [36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51];

        //init on page load
        var noteMap = {},
            r = __.random;

        //set up the audio chain w some initial values
        __().microsynth({
            lfo_type:"square",
            lfo_intensity:100,
            lfo_speed:25,
            osc_type:"sine",
            osc_frequency:440,
            osc_detune:0,
            lp_q:15,
            lp_frequency:440,
            adsr_envelope:0.5,
            gain_volume:1
        }).delay({
            id:"delay1",
            damping:r(0,100)/100,
            cutoff:r(0,3000),
            feedback:r(0,100)/100,
            delay:0.1
        }).panner({
            pan:-1
        }).overdrive(
            r(0,100)
        ).dac();

        //connect another delay panned the opposite direction
        __("microsynth").delay({
            id:"delay2",
            damping:r(0,100)/100,
            cutoff:r(0,3000),
            feedback:r(0,100)/100,
            delay:0.0
        }).panner({
            "pan":1
        }).connect("overdrive").play();

        //initialize midi
        __.midi_init(function(){

            //on note on
            __.midi_noteon(function(data){

                var selector = "pad_"+data[1];

                //grab the data for that note
                var note_data = noteMap[selector];

                //trigger the note on
                __("microsynth").microsynth("noteOn", note_data);

                //ramp low pass freq and low pass q
                __("microsynth lowpass").ramp(note_data.lp_ramp[0],note_data.lp_ramp[1],"frequency",note_data.lp_ramp[2]).
                        ramp(note_data.lp_ramp[2],note_data.lp_ramp[1],"q",note_data.lp_ramp[0]);

                //ramp lfo frequency and intensity
                __("microsynth lfo").ramp(note_data.lfo_ramp[0],note_data.lfo_ramp[1],"frequency",note_data.lfo_ramp[2]).
                        ramp(note_data.lfo_ramp[0],note_data.lfo_ramp[1],"gain",note_data.lfo_ramp[2]);

                //set delay and feedback values for delay 1
                __("#delay1").time(note_data.delay1_delay).feedback(note_data.delay1_feedback);

                //set delay and feedback values for delay 2
                __("#delay2").time(note_data.delay2_delay).feedback(note_data.delay2_feedback);

                //set distortion level for overdrive
                __("overdrive").drive(note_data.overdrive);

            });

            //when note off
            __.midi_noteoff(function(data){

                var selector = "pad_"+data[1];

                //trigger the note on
                __("microsynth").microsynth("noteOff");

            });

        });

        //run on page load- make the data for each note
        function makeNoteData() {
            function getOSCType() {
                return ["triangle","square","sine","saw"][r(0,3)];
            }
                pad_array.forEach(function(el,i,arr){
                var id = "pad_"+el;
                noteMap[id]={
                    osc_type:getOSCType(),
                    pitch:__.scales("wholetone")[r(0,6)] + (r(3,7) * 12),
                    velocity:r(0,127),
                    envelope:[(r(0,100)/100),(r(0,100)/100),(r(0,100)/100),(r(0,100)/100)],
                    lp_ramp:[r(0,100),(r(0,100)/100),r(0,1000)],
                    lfo_ramp:[r(0,100),(r(0,100)/100),r(0,100)],
                    overdrive:r(0,100),
                    delay1_delay:r(0,100)/1000,
                    delay2_delay:r(0,100)/1000,
                    delay1_feedback:r(0,100)/100,
                    delay2_feedback:r(0,100)/100
                };
            });
        }
        makeNoteData();
    })();

</script>

</body>
</html>