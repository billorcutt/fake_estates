<html>
<head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="https://rawgit.com/billorcutt/i_dropped_my_phone_the_screen_cracked/master/dist/cracked.js"></script>
    <script src="./synth.cracked.js"></script>
    <style>
        .tile {
            float:left;
            height:200px;
            width:200px;
            background-color: #eeeeee;
            margin: 5px 5px;
        }
        .br {
            clear: both;
        }
        .wrapper {
            padding:5% 20%;
            min-width : 900px;
        }
    </style>
</head>
<body>

<div class="wrapper">

    <div id="tile_49" class="tile br"></div>
    <div id="tile_55" class="tile"></div>
    <div id="tile_51" class="tile"></div>
    <div id="tile_53" class="tile"></div>
    <div id="tile_48" class="tile br"></div>
    <div id="tile_47" class="tile"></div>
    <div id="tile_45" class="tile"></div>
    <div id="tile_43" class="tile"></div>
    <div id="tile_40" class="tile br"></div>
    <div id="tile_38" class="tile"></div>
    <div id="tile_46" class="tile"></div>
    <div id="tile_44" class="tile"></div>
    <div id="tile_37" class="tile br"></div>
    <div id="tile_36" class="tile"></div>
    <div id="tile_42" class="tile"></div>
    <div id="tile_82" class="tile"></div>

</div>

<script>

    (function() {
        //init on page load
        var noteMap = {},
            r = __.random;

        //set up the audio chain w some initial values
        __().microsynth({
            lfo_type:"square",
            lfo_intensity:100,
            lfo_speed:25,
            osc_type:"sine",
            osc_frequency:440,
            osc_detune:0,
            lp_q:15,
            lp_frequency:440,
            adsr_envelope:0.5,
            gain_volume:1
        }).delay({
            id:"delay1",
            damping:r(0,100)/100,
            cutoff:r(0,3000),
            feedback:r(0,100)/100,
            delay:0.1}
        ).panner({
            "pan":-1
        }).overdrive(
            r(0,100)
        ).dac();

        //connect another delay panned the opposite direction
        __("microsynth").delay({
            id:"delay2",
            damping:r(0,100)/100,
            cutoff:r(0,3000),
            feedback:r(0,100)/100,
            delay:0.0
        }).panner({
            "pan":1
        }).connect("overdrive").play();

        //initialize midi
        __.midi_init(function(){

            //on note on
            __.midi_noteon(function(data){

                var selector = "tile_"+data[1];
                var $node = $("#"+selector);

                //grab the data for that note
                var note_data = noteMap[selector];

                //trigger the note on
                __("microsynth").microsynth("noteOn", note_data);

                //ramp low pass freq and low pass q
                __("microsynth lowpass").ramp(note_data.lp_ramp[0],note_data.lp_ramp[1],"frequency",note_data.lp_ramp[2]).
                        ramp(note_data.lp_ramp[2],note_data.lp_ramp[1],"q",note_data.lp_ramp[0]);

                //ramp lfo frequency and intensity
                __("microsynth lfo").ramp(note_data.lfo_ramp[0],note_data.lfo_ramp[1],"frequency",note_data.lfo_ramp[2]).
                        ramp(note_data.lfo_ramp[0],note_data.lfo_ramp[1],"gain",note_data.lfo_ramp[2]);

                //set delay and feedback values for delay 1
                __("#delay1").time(note_data.delay1_delay).feedback(note_data.delay1_feedback);

                //set delay and feedback values for delay 2
                __("#delay2").time(note_data.delay2_delay).feedback(note_data.delay2_feedback);

                //set distortion level for overdrive
                __("overdrive").drive(note_data.overdrive);

                //call the ui display
                display(data,$node);

            });

            //when note off
            __.midi_noteoff(function(data){

                var selector = "tile_"+data[1];
                var $node = $("#"+selector);

                //trigger the note on
                __("microsynth").microsynth("noteOff");

                //delay the noteoff so that the ui is visible for more than a blip
                setTimeout(function(){
                    display(data,$node);
                },100);
            });

        });

        //ui
        function display(data,node) {
            var color = data[2] ? "#ccc" : "#eee";
            node.css("background-color", color);
        }

        //run on page load- make the data for each note
        function makeNoteData() {
            function getOSCType() {
                return ["triangle","square","sine","saw"][r(0,3)];
            }
            $("div.tile").each(function(i,el,arr){
                var id = el.id;
                noteMap[id]={
                    osc_type:getOSCType(),
                    pitch:__.scales("wholetone")[r(0,6)] + (r(3,7) * 12),
                    velocity:r(0,127),
                    envelope:[(r(0,100)/100),(r(0,100)/100),(r(0,100)/100),(r(0,100)/100)],
                    lp_ramp:[r(0,100),(r(0,100)/100),r(0,1000)],
                    lfo_ramp:[r(0,100),(r(0,100)/100),r(0,100)],
                    overdrive:r(0,100),
                    delay1_delay:r(0,100)/1000,
                    delay2_delay:r(0,100)/1000,
                    delay1_feedback:r(0,100)/100,
                    delay2_feedback:r(0,100)/100
                };
            });
            console.log(noteMap)
        }
        makeNoteData();
    })();

</script>

</body>
</html>